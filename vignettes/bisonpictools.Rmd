---
title: "bisonpictools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{bisonpictools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bisonpictools)
```

The goal of bisonpictools is to facilitate the visualization and analysis of camera trap data from the Ronald Wood Bison herd.

## Installation

```{r, eval = FALSE}
# install.packages("remotes")
remotes::install_github("poissonconsulting/bisonpictools")
```

## Data Visualization

The ratio plotted by `bpt_plot_ratios` is `numerator:(denominator:numerator)`.

For example, the adult cow:(bull + cow) ratio plotted over all years and locations:
``` {r, fig.dim = c(10, 6)}
library(bisonpictools)
bpt_plot_ratios(
  bpt_event_data,
  bpt_location_data,
  numerator = "fa",
  denominator = "ma"
)
```

It is also possible to subset the data to include one or more camera trap locations and/or study years:

``` {r, fig.dim = c(10, 6)}
bpt_plot_ratios(
  bpt_event_data,
  bpt_location_data,
  numerator = "fa",
  denominator = "ma",
  study_years = "2019-2020",
  locations = c("LOCID1", "LOCID2")
)
```


Several age/sex classes can be combined to plot ratios of interest.
For example, this plots the calf:(cow + calf) ratio:

```{r, fig.dim = c(10, 6)}
bpt_plot_ratios(
  bpt_event_data,
  bpt_location_data,
  numerator = c("f0", "m0", "u0"),
  denominator = c("fa")
)
```

## Data Analysis

Launch the local data analysis app 

```{r, eval = FALSE}
# Launch app
```

Install Stan

```{r, eval = FALSE}
# Install correct version of Stan
install.packages("rstan")
```

Read in data saved from the hosted app 

```{r, eval = FALSE}
# Change `dir` to the folder where you have saved the data
dir <- "myfilepath"
event_data <- readr::read_csv(file.path(dir, "event_data.csv"))
location_data <- readr::read_csv(file.path(dir, "location_data.csv"))
census_data <- readr::read_csv(file.path(dir, "census_data.csv"))
proportion_calf_data <- readr::read_csv(file.path(dir, "proportion_calf_data.csv"))
```

Run the analysis

- `event_data` is the camera trap event data frame saved from the first app
- `location_data` is the location data frame saved from the first app

<!-- - `census` is the number of bison in the herd from census counts -->
<!-- - `census_cv` is the coefficient of variation of the census counts (standard deviation / estimate) -->
<!-- - `census_study_year` is the study year of the census counts (study year starts on Apr. 1) -->
<!-- - `census_day_of_year` is the day of the year of the census counts (first day of year is Apr. 1).  -->
<!--   - E.g. if the census was on the last day of March in 2023, -->
<!--   - `census_study_year` = "2022-2023" -->
<!--   - `census_day_of_year` = 365L -->
<!-- - `proportion_calf` is the proportion of calves in the herd -->
<!-- - `proportion_calf_cv` is the coefficient of variation of the proportion of calves in the herd -->
<!-- - `proportion_calf_study_year` is the study year of the proportion of calves in the herd (study year starts on Apr. 1) -->
<!-- - `proportion_calf_day_of_year` is the day of the year of the proportion of calves in the herd (first day of year is Apr. 1).  -->
<!--   - E.g. if the proportion of calves was estimated on the last day of March in 2022, -->
<!--   - `proportion_calf_study_year` = "2021-2022" -->
<!--   - `proportion_calf_day_of_year` = 365L -->

- `analysis_mode` controls the number of iterations and chains in the model run
  - `"report"` is the default and is used for the full analysis
  - `"debug"` is used for checking for errors if the model does not sample
  - `"quick"` is used for running through a quick run of the model for demonstration purposes

- `nthin` controls the thinning of the MCMC samples; 
  - `nthin = 1L` saves all samples and is the default
  - increase `nthin` if model is not converging

```{r, eval = FALSE}
analysis <- bpt_analyse(
  event_data = bpt_event_data,
  location_data = bpt_location_data,
  census_data = bpt_census_data,
  proportion_cafl_data = bpt_proportion_calf_data,
  nthin = 1L,
  analysis_mode = "report"
)
```

```{r, echo = FALSE}
analysis <- readRDS(file = system.file(package = "bisonpictools", "test-objects/analysis.RDS"))
```

Save the analysis object

```{r, eval = FALSE}
# Save analysis object
bpt_save_analysis(analysis, file = "file_path/analysis")
```

Make predictions 

```{r}
# Predict total abundance
bpt_predict_abundance_total(analysis)
```

```{r, eval = FALSE}
# Can predict other values using the following functions
bpt_predict_abundance_class(analysis) # Predicts abundance by class
bpt_predict_survival(analysis) # Predicts survival rates
bpt_predict_fecundity(analysis) # Predicts fecundity rate and proportion of reproductive cows
bpt_predict_ratios(analysis) # Predicts population ratios
```


## Plot Predictions

```{r, eval = FALSE}
# Load analysis object
bpt_load_analysis("file_path/analysis")
```

```{r, fig.dim = c(7, 6)}
# Plot predicted abundances by class
bpt_plot_predictions(analysis, prediction = "abundance-class")
```

```{r, fig.dim = c(7, 6)}
# Plot total abundance
bpt_plot_predictions(analysis, prediction = "abundance-total")
```

```{r, fig.dim = c(7, 6)}
# Plot survival rates
bpt_plot_predictions(analysis, prediction = "survival")
```

```{r, fig.dim = c(7, 6)}
# Plot fecundity rates
bpt_plot_predictions(analysis, prediction = "fecundity")
```

```{r, fig.dim = c(7, 6)}
# Plot ratios
bpt_plot_predictions(analysis, prediction = "ratios")
```
